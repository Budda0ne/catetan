---
layout: post
title: Load Balancing Outgoing Connection
date: '2012-08-14T14:30:00.001+07:00'
author: Phate Holloway
tags:
- Linux
- Tutorial
last_modified_at: '2013-03-13T01:11:11.312+07:00'
blogger_id: tag:blogger.com,1999:blog-8168996750712797250.post-3389963700571498537
redirect_from: /2012/08/load-balancing-outgoing-connection.html
---

Apa yang dimaksud <b>Load Balancing</b> pada bahasan ini?<br />Yang saya maksud <b>Outgoing Load Balancing</b> disini adalah balancing dua  koneksi internet atau lebih dan mengoptimalkan koneksi tersebut.<br />Untuk menggunakan load balancing ini, gunakan pf pool <span style="color: #cc0000;">http://www.openbsd.org/faq/pf/pools.html#outgoing</span><br />Dalam contoh kali ini akan saya sajikan 2 koneksi saja, untuk lebih dari  dua koneksi silahkan anda mencobanya dan berexperiment sendiri.<br />Pra Syarat:<br /><ol><li>kernel sudah dikompile support pf</li><li>ada 3 buah lancard, 2 untuk koneksi wan dan 1 untuk koneksi lan</li><li>dua line koneksi ISP atau Speedy</li></ol>Lakukan compile  kernel agar support pf firewall dan builtin dalam kerne merujuk ke <span style="color: #990000;">http://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/firewalls-pf.html</span>.<br /><br /><code># cd /usr/src/sys/i386/conf<br /># cp GENERIC ROUTER<br /># ee ROUTER<br />#——– Tambahkan baris berikut pada konfigurasi kernel anda ——–#<br />###—untuk support PF—-###<br />device pf<br />device pflog<br />device pfsync<br />###—untuk support altq cbq jika diperlukan nanti —#<br />options ALTQ<br />options ALTQ_CBQ<br />options ALTQ_RED<br />options  ALTQ_HFSC<br />options ALTQ_PRIO<br />options ALTQ_NOPCC</code><br />Save konfigurasi kernel tersebut.<br />Setelah mengedit konfigurasi kernel lalu saya mengcompile kernel ulang.<br /><code># cd /usr/src/sys/i386/conf<br /># config ROUTER<br /># cd ../compile/ROUTER<br /># make cleandepend; make depend; make; make install</code><br /><br />Setelah tahap instalasi kernel baru selesai,  saya perlu mengonfigurasi rc.conf untuk keperluan pf berjalan ketika boot:<br /><br /><code># ee  /etc/rc.conf<br />###—tambahkan ini —###<br />pf_enable=”YES” # Enable PF (load module if required)<br />pf_rules=”/etc/pf.conf”  # rules definition file for pf<br />pf_flags=”" # additional flags for pfctl startup<br />pflog_enable=”YES” # start pflogd(8)<br />pflog_logfile=”/var/log/pflog”# where pflogd should store the logfile<br />pflog_flags=”" # additional flags for pflogd startup<br />gateway_enable=”YES” # Enable as LAN gateway<br />router_flags”=”-q”<br />router= “sbin/routed”<br />router_enable=”YES”<br />defaultrouter=”10.0.0.1″ #masukan salah satu gateway koneksi isp anda</code><br /><br />Save hasil edit rc.conf tersebut.<br />Langkah selanjutnya membuat konfigurasi pf.conf untuk pool loadbalancing. Dalam percobaan ini saya menggunakan konfigurasi <a rel="nofollow" href="http://www.openbsd.org/faq/pf/pools.html#outexample">http://www.openbsd.org/faq/pf/pools.html#outexample.</a><br /><br /><code># ee /etc/pf.conf<br />#—– Isi konfigurasi pf —–#<br />lan_net = “192.168.1.0/24″<br />int_if  = “rl2″<br />ext_if1 = “rl0″<br />ext_if2 = “rl1″<br />ext_gw1 = “10.0.0.1″<br />ext_gw2 = “10.0.0.2″<br />#  nat outgoing connections on each internet interface<br />nat on $ext_if1 from $lan_net to any -&gt; ($ext_if1)<br />nat on $ext_if2 from $lan_net to any -&gt; ($ext_if2)<br />#  default deny<br />block in  from any to any<br />block out from any to any<br />#  pass all outgoing packets on internal interface<br />pass out on $int_if from any to $lan_net<br />#  pass in quick any packets destined for the gateway itself<br />pass in quick on $int_if from $lan_net to $int_if<br />#  load balance outgoing tcp traffic from internal network.<br />pass in on $int_if route-to \<br />{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br />#  load balance outgoing udp and icmp traffic from internal network<br />pass in on $int_if route-to \<br />{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br />proto { udp, icmp } from $lan_net to any keep state<br />#  general “pass out” rules for external interfaces<br />pass out on $ext_if1 proto tcp from any to any flags S/SA modulate state<br />pass out on $ext_if1 proto { udp, icmp } from any to any keep state<br />pass out on $ext_if2 proto tcp from any to any flags S/SA modulate state<br />pass out on $ext_if2 proto { udp, icmp } from any to any keep state<br />#  route packets from any IPs on $ext_if1 to $ext_gw1 and the same for<br />#  $ext_if2 and $ext_gw2<br />pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 to any<br />pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 to any<br />#—selesai—#</code><br /><br />Save konfigurasi pf tersebut.<br /># reboot<br /><br />Selesai sudah tahap pembuatan router <em>load balancing</em> dua koneksi internet.<br /><br />Saran: Untuk kenyamanan anda silahkan customize port-port yang diperlukan untuk dilewatkan atau diblok.<br />Periksa kembali dokumentasi <a rel="search" href="http://www.idlohulhaq.com/search?q=squid">squid</a> dan pf jika anda ingin menjalankan <a rel="search" href="http://www.idlohulhaq.com/search?q=transparent%20proxy">transparent proxy</a>.<br /><br />sumber: <a rel="nofollow" href="http://yudymardianto.wordpress.com">yudymardianto.wordpress.com</a>